---
title: "writeup"
author: "Zhengqi Tian"
date: "9/29/2021"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

***Background***
After We find the probability of winning the world series, this time we want to discuss if the home advantage actually work. To find the outcome, we go back t he competition between Braves and Yankees. Bravers has the game advantage when the game played in Atlanta instead of New York City.

Game location | No advantage |      Advantage
--------------|--------------|---------------------
       ATL    |     Pb       |PBH = PB $\times$ 1.1
       NYC    |     Pb       |PBA = 1 - (1 - PB)$\times$ 1.1
       
We will use three libraries and the all=possible-world-series-outcomes to answer questions     
```{r}
library(tidyverse)
library(data.table)
library(ggplot2)
# Load the file
apo <- fread("https://raw.githubusercontent.com/thomasgstewart/data-science-5620-fall-2021/master/deliverables/assets/all-possible-world-series-outcomes.csv")
```

***Question 1: Compute analytically the probability that the Braves win the world series when the sequence of game locations is {NYC, NYC, ATL, ATL, ATL, NYC, NYC}. (The code below computes the probability for the alternative sequence of game locations. Note: The code uses data.table syntax, which may be new to you. This is intentional, as a gentle way to introduce data.table.) Calculate the probability with and without home field advantage when PB = 0.55. What is the difference in probabilities?***


To answer the first question,we need to define a sequence of game locations. based on the question, Brave will have game in {NYC, NYC, ATL, ATL, ATL, NYC, NYC}. We use 0 to represent NYC and 1 to represent ATL。

```{r}
# Home field indicator
hfi <- c(0,0,1,1,1,0,0) #{NYC, NYC, ATL, ATL, ATL, NYC, NYC}. 
```

Based on the above home advantage table, we can also set upt the probability with home advantage and probability without home advantage when tyhe advantager multiplier will be 1.1
```{r}
# P_B
pb <- 0.55
advantage_multiplier <- 1.1 # Set = 1 for no advantage
pbh <- pb * advantage_multiplier
pba <- 1 - (1 - pb) * advantage_multiplier

```

In this part, we will use the parameters we defined before. the following expressions help use to mimic each possible outcome and store data in the sheet. 

```{r}
# the probability of each possible outcome
apo[, p := NA_real_] # Initialize new column in apo to store prob
for(i in 1:nrow(apo)){
  prob_game <- rep(1, 7)
  for(j in 1:7){
    p_win <- ifelse(hfi[j], pbh, pba)
    prob_game[j] <- case_when(
        apo[i,j,with=FALSE] == "W" ~ p_win
      , apo[i,j,with=FALSE] == "L" ~ 1 - p_win
      , TRUE ~ 1
    )
  }
  apo[i, p := prod(prob_game)] # Data.table syntax
}

```


The following expression display the probability of overall series out comes without home advantage.

```{r}
# Probability of overall World Series outcomes without home advantage

p.win<-pnbinom(3, 4, 0.55)
p.win

```


Now, we have already have all required data, the next step is to find difference between probability of win without home advantage and probability of win with home advantage. The following expression is for the probability of overall world series out come with the home advantage. 
```{r}
# Probability of overall World Series outcomes with home advantage
p.home.adv.win <- as.numeric(apo[, sum(p), overall_outcome][1,2])
p.home.adv.win
```


Now we are able to have the difference. Thus, given Pb=0.55, the probability of the Braves winning the world series without home advantage is larger than the probability with home advantage.

```{r}
difference <-p.win-p.home.adv.win
difference 
```



***Question 2: Calculate the same probabilities as the previous question by simulation***

Comparing with the analytic method used for question 1,  we will use simulation method for question two here. It is so true that the first question's expression is a great modeal to answer the question here. The general idea here is same. We need to find the probabilities with home advantage and without home advantage for the difference. 

The following expression is a situation without home-field advantage influence. the general logic behind it is close to the analytic method. Thus for the most of part, it is close to the expression we just used to calculate each possible outcome. Major differents is that we need stimulate the possible outcome each game, define the win solution of each simulation, and calculate the average simulation under 10000 running. Here we define the win situation is when Braver has more than three wins in each round. we record the win in the simulation and find ratio of total win over total game
```{r}
set.seed(1)
test.size=10000
simulation.game <- rep(NA, test.size)
for (i in seq_along(simulation.game)){
  prob_game <- rep(NA,7)
  for(j in 1:7){
    prob_game[j] <- rbinom(1,1,0.55)
  }
  simulation.game[i] <- ifelse(sum(prob_game)>3, 1, 0)
}
simulation.game <- sum(simulation.game)/test.size
simulation.game


```
The following expression is a situation with home-field advantage influence. the general logic behind it is close to a situation without home-field advantage influence. at this time we need redefine the Pb win based on the home advantage table, and find the average simulation under 10000 running.

```{r}
set.seed(1)
simulation.game.adv<- rep(NA, test.size)
for (i in seq(simulation.game.adv)){
  prob_game <- rep(NA,7)
  for(j in 1:7){
    prob_game[j] <- rbinom(1,1,ifelse(hfi[j], pbh, pba))
  }
  simulation.game.adv[i] <- ifelse(sum(prob_game)>3, 1, 0)
}
simulation.game.adv <- sum(simulation.game.adv)/test.size
simulation.game.adv

```

With both probability outcomes, now we are able to find the difference. The interest is that the simulation game wining without home advantage has a higher probability than siomulation gaming winning with home advantage does. The outcome is same with question 1.
```{r}

simulation.game-simulation.game.adv

```

***Question 3: What is the absolute and relative error for your simulation in the previous question?***


The definition of absolute error is : Absolute error = |p̂−p|

Thus, we can find the absolute error between simulation winning without home advantage and analytic winning without home advantage

```{r}
abs_error_simulation.game.adv <-abs(simulation.game-p.win)
abs_error_simulation.game.adv
```
We can find the absolute error between simulation winning with home advantage and analytic winning with home advantage
```{r}
abs_error_simulation.game.adv <- abs(simulation.game.adv - p.home.adv.win)
abs_error_simulation.game.adv 

```


The definition of relative error is : Relative error = |p̂−p|/p/.

Thus, we can find the relative error between simulation winning without home advantage and analytic winning without home advantage
```{r}

rel_error_simulation.game.adv <-abs(simulation.game-p.win )/simulation.game
rel_error_simulation.game.adv

```
We can find the relative error between simulation winning with home advantage and analytic winning with home advantage
```{r}
rel_error_simulation.game.adv <- abs(simulation.game.adv - p.home.adv.win)/simulation.game.adv
rel_error_simulation.game.adv 

```

We prefer to use relative error here.

***Question 4: Does the difference in probabilities (with vs without home field advantage) depend on PB?***
To answer the question, the first thing is to define Pb. it is clear that Pb can be any number between 0 to 1. pb in 0 to 0.5 will be a opposite mirror affect with pb in 0.5 to 1. However we have to exclude pb after 0.9 , because if pb is larger than 0.9, probability of home advantage win will over 1. Thus, we want to find all possible pb from 0.1 to 0.9 with 0.01 break. Here are 50 observations.
```{r}
#Setup the probability
pb<- seq(0.1,0.9,0.01)
pb
```

Now we are going to use analytic method to find all possible outcomes. Here we want to know the probability of winning with no home advantage, probability of wining with home advantage, and difference between two situation

```{r}
#probability of no home advantage win
p.win<-rep(NA,length(pb))

#probability of home advantage win
p.home.adv.win <- rep(NA,length(pb))

#difference between two situationtg
difference <- rep(NA,length(pb))


```

Now we are able to find all observations in each pb. The following expression are similar wit question 1's expression and idea. 

```{r}

for (x in seq(pb)) {
  advantage_multiplier <- 1.1
  pbh <- pb[x] * advantage_multiplier
  pba <- 1 - (1 - pb[x]) * advantage_multiplier

  # Calculate the probability of winning without home advantage
  p.win [x] <- pnbinom(3, 4, pb[x])

  # Calculate the probability of winning with home advantage
  apo[, x := NA_real_] # Initialize new column in apo to store prob
  for(i in 1:nrow(apo)){
    prob_game <- rep(1, 7)
    for(j in 1:7){
      p_win <- ifelse(hfi[j], pbh, pba)
      prob_game[j] <- case_when(
          apo[i,j,with=FALSE] == "W" ~ p_win
        , apo[i,j,with=FALSE] == "L" ~ 1 - p_win
        , TRUE ~ 1
      )
    }
  apo[i, x := prod(prob_game)] # Data.table syntax
  }
  p.home.adv.win[x] <- as.numeric(apo[, sum(x), overall_outcome][1,2])

  # Calculate the difference
  difference[x] <- p.win [x] - p.home.adv.win[x]
}

```

Now we got our data!

```{r}
data<-data.frame(pb,p.home.adv.win,p.win,difference)
data
```
Thanks for ggplot! Now we are able to find the relationship between probability (with vs without home field advantage) and Pb. We can see that as Pb goes up from 0.1 to round 0.3, the difference goes up, meaning the home advantage is not helpful. however, the difference goes down to negative , when pb goes from 0.3 to 0.75, meaning that thhe home advatage will increase in win probability. Finally, the difference close to 0.
```{r}
ggplot(data, aes(x=pb,y=difference))+geom_point()+
  theme_bw()+
  geom_smooth()+
  labs(
    title="relationship between probabilities and Pb difference",
    x="Pb rate",
    y="Probability difference"
  )
```
***Question 5 Does the difference in probabilities (with vs without home field advantage) depend on the advantage factor? (The advantage factor in PBH and PBA is the 1.1 multiplier that results in a 10% increase for the home team. Generate a plot to answer this question.***

The general idea here is similar with question 4. However, this time we will have pb=0.55, but a change home advantage multiplier. It the clear that home advantage multiplier has a range from 1 to 2. However, we have to exclude any after 1.8 here, because once the advantage multiplier is larger than 1.8, the probability of win will over 1. Thus, we set the range from 1 to 1.8 and are able to find all possible outcome for probability of winning with no home advantage, probability of wining with home advantage, and difference between two situation

```{r}
field.advantage <- seq(1,1.8,0.01)
p.home.adv.win<- rep(NA,length(field.advantage))
p.win  <- rep(NA,length(field.advantage))
difference<- rep(NA,length(field.advantage))


for (x in seq(field.advantage)) {
  advantage_multiplier <- field.advantage[x]
  pbh <- 0.55 * advantage_multiplier
  pba <- 1 - (1 - 0.55) * advantage_multiplier
  
# Calculate the probability of winning without home advantage
  p.win [x] <- pnbinom(3, 4, 0.55)

# Calculate the probability of each possible outcome
  apo[, x := NA_real_] # Initialize new column in apo to store prob
  for(i in 1:nrow(apo)){
    prob_game <- rep(1, 7)
    for(j in 1:7){
      p_win <- ifelse(hfi[j], pbh, pba)
      prob_game[j] <- case_when(
          apo[i,j,with=FALSE] == "W" ~ p_win
        , apo[i,j,with=FALSE] == "L" ~ 1 - p_win
        , TRUE ~ 1
      )
    }
  apo[i, x := prod(prob_game)] # Data.table syntax
  }
  p.home.adv.win[x] <- as.numeric(apo[, sum(x), overall_outcome][1,2])
  
# Calculate the difference
  difference[x] <- p.win [x] - p.home.adv.win[x]
}

data<-data.frame(field.advantage,p.home.adv.win,p.win,difference)
data
```
With ggplot we find that the higher field advantage rate will have a higher probability difference rate when pb is 0.55. Probability with home advantage will be less than probability without home advantages.
```{r}
ggplot(data, aes(x=field.advantage,y=difference))+geom_point()+
  theme_bw()+
  geom_smooth()+
  labs(
    title="relationship between probabilities and the advantage factor",
    x="Field Advantage Rate",
    y="Probability difference"
  )
```
